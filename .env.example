# =============================================================================
# Freebird Docker Quickstart Configuration
# =============================================================================
# Copy this file to `.env` and customize the values for your deployment.
#
# Usage:
#   cp .env.example .env
#   # Edit .env with your values
#   docker-compose up --build
#
# =============================================================================

# =============================================================================
# ISSUER CONFIGURATION
# =============================================================================

# Unique identifier for this issuer (appears in tokens)
ISSUER_ID=issuer:docker:v1

# Server bind address (use 0.0.0.0 to listen on all interfaces in Docker)
ISSUER_BIND_ADDR=0.0.0.0:8081

# Token time-to-live in minutes (1-1440 minutes / 24 hours max)
TOKEN_TTL_MIN=10

# TLS Configuration (set to true in production, false for local dev)
REQUIRE_TLS=false

# Set to true if running behind a reverse proxy (for proper client IP detection)
BEHIND_PROXY=false

# -----------------------------------------------------------------------------
# Admin API Configuration
# -----------------------------------------------------------------------------
# REQUIRED for admin endpoints (user management, stats, key rotation)
# Must be at least 32 characters
# SECURITY: Change this in production! Use a secrets manager.
ADMIN_API_KEY=dev-admin-key-must-be-at-least-32-characters-long

# -----------------------------------------------------------------------------
# Key Storage Paths (mounted in Docker volumes)
# -----------------------------------------------------------------------------
ISSUER_SK_PATH=/data/keys/issuer_sk.bin
KEY_ROTATION_STATE_PATH=/data/keys/key_rotation_state.json

# -----------------------------------------------------------------------------
# Federation Data Path
# -----------------------------------------------------------------------------
# Directory for federation store data (trusted issuers, etc.)
# Default: /data/federation (for Docker)
# For bare metal: /var/lib/freebird/federation
FEDERATION_DATA_PATH=/data/federation

# -----------------------------------------------------------------------------
# Epoch Configuration (Key Rotation)
# -----------------------------------------------------------------------------
# Duration of each epoch (supports human-readable: 1d, 24h, etc.)
# Default: 1d (1 day = 86400 seconds)
EPOCH_DURATION=1d

# Number of previous epochs to accept (default: 2)
EPOCH_RETENTION=2

# -----------------------------------------------------------------------------
# Sybil Resistance Configuration
# -----------------------------------------------------------------------------
# Options: none, invitation, pow, rate_limit, progressive_trust,
#          proof_of_diversity, multi_party_vouching, federated_trust,
#          webauthn, combined
SYBIL_RESISTANCE=invitation

# --- Invitation System (only applies if SYBIL_RESISTANCE=invitation) ---
# Number of invitations each user can send
SYBIL_INVITE_PER_USER=5

# Cooldown between sending invitations (supports: 1h, 30m, 3600, etc.)
SYBIL_INVITE_COOLDOWN=1h

# Invitation expiration time (supports: 30d, 720h, etc.)
SYBIL_INVITE_EXPIRES=30d

# Wait time before new users can send invitations
SYBIL_INVITE_NEW_USER_WAIT=30d

# Path to invitations persistence file
SYBIL_INVITE_PERSISTENCE_PATH=/data/state/invitations.json

# Autosave interval
SYBIL_INVITE_AUTOSAVE_INTERVAL=5m

# Bootstrap users (format: "username:invite_count,username2:invite_count2")
# These users start with invitations available
SYBIL_INVITE_BOOTSTRAP_USERS=admin:100

# --- Proof of Work (only applies if SYBIL_RESISTANCE=pow) ---
# SYBIL_POW_DIFFICULTY=20

# --- Rate Limiting (only applies if SYBIL_RESISTANCE=rate_limit) ---
# SYBIL_RATE_LIMIT=1h

# --- Progressive Trust (only applies if SYBIL_RESISTANCE=progressive_trust) ---
# Format: "min_age:max_tokens:cooldown" - age and cooldown support human-readable durations
# SYBIL_PROGRESSIVE_TRUST_LEVELS=0:1:1d,30d:10:1h,90d:100:1m
# SYBIL_PROGRESSIVE_TRUST_PERSISTENCE_PATH=/data/state/progressive_trust.json
# SYBIL_PROGRESSIVE_TRUST_AUTOSAVE=5m
# SYBIL_PROGRESSIVE_TRUST_SALT=change-in-production

# --- Proof of Diversity (only applies if SYBIL_RESISTANCE=proof_of_diversity) ---
# SYBIL_PROOF_OF_DIVERSITY_MIN_SCORE=40
# SYBIL_PROOF_OF_DIVERSITY_PERSISTENCE_PATH=/data/state/proof_of_diversity.json
# SYBIL_PROOF_OF_DIVERSITY_AUTOSAVE=5m
# SYBIL_PROOF_OF_DIVERSITY_SALT=change-in-production

# --- Multi-Party Vouching (only applies if SYBIL_RESISTANCE=multi_party_vouching) ---
# SYBIL_MULTI_PARTY_VOUCHING_REQUIRED=3
# SYBIL_MULTI_PARTY_VOUCHING_COOLDOWN=1h
# SYBIL_MULTI_PARTY_VOUCHING_EXPIRES=30d
# SYBIL_MULTI_PARTY_VOUCHING_NEW_USER_WAIT=30d
# SYBIL_MULTI_PARTY_VOUCHING_PERSISTENCE_PATH=/data/state/multi_party_vouching.json
# SYBIL_MULTI_PARTY_VOUCHING_AUTOSAVE=5m
# SYBIL_MULTI_PARTY_VOUCHING_SALT=change-in-production

# --- Federated Trust (only applies if SYBIL_RESISTANCE=federated_trust) ---
# SYBIL_FEDERATED_TRUST_ENABLED=true
# SYBIL_FEDERATED_TRUST_MAX_DEPTH=2
# SYBIL_FEDERATED_TRUST_MIN_PATHS=1
# SYBIL_FEDERATED_TRUST_REQUIRE_DIRECT=false
# SYBIL_FEDERATED_TRUST_MIN_TRUST_LEVEL=50
# SYBIL_FEDERATED_TRUST_CACHE_TTL=1h
# SYBIL_FEDERATED_TRUST_MAX_TOKEN_AGE=10m

# -----------------------------------------------------------------------------
# WebAuthn Configuration (requires feature flag "human-gate-webauthn")
# -----------------------------------------------------------------------------
# Uncomment and configure if using WebAuthn for Proof of Humanity
# WEBAUTHN_RP_ID=localhost
# WEBAUTHN_RP_NAME=Freebird
# WEBAUTHN_RP_ORIGIN=http://localhost:8081
# WEBAUTHN_REDIS_URL=redis://redis:6379
# WEBAUTHN_CRED_TTL=1d
# WEBAUTHN_MAX_PROOF_AGE=1h

# -----------------------------------------------------------------------------
# HSM Configuration (Hardware Security Module)
# -----------------------------------------------------------------------------
# See .env.hsm.example for complete HSM configuration
# HSM_ENABLE=false
# HSM_MODE=storage
# HSM_MODULE_PATH=/usr/lib/softhsm/libsofthsm2.so
# HSM_SLOT=0
# HSM_PIN=1234
# HSM_KEY_LABEL=freebird-voprf-key

# =============================================================================
# VERIFIER CONFIGURATION
# =============================================================================

# Server bind address
VERIFIER_BIND_ADDR=0.0.0.0:8082

# Issuer metadata URL (use Docker service name for internal network)
ISSUER_URL=http://issuer:8081/.well-known/issuer

# Maximum acceptable clock skew in seconds (default: 300 = 5 minutes)
MAX_CLOCK_SKEW_SECS=300

# Issuer metadata refresh interval in minutes
REFRESH_INTERVAL_MIN=10

# Redis URL for nullifier storage (production recommended)
# If not set, uses in-memory storage (loses data on restart)
REDIS_URL=redis://redis:6379

# Epoch configuration (should match issuer settings)
VERIFIER_EPOCH_DURATION=1d
VERIFIER_EPOCH_RETENTION=2

# -----------------------------------------------------------------------------
# Trust Policy Configuration (Layer 2 Federation)
# -----------------------------------------------------------------------------
# Enable/disable federation trust graph traversal (default: true)
# TRUST_POLICY_ENABLED=true

# Maximum depth to traverse in the trust graph (default: 2)
# 0 = direct vouches only, higher = more hops allowed
# TRUST_POLICY_MAX_DEPTH=2

# Minimum number of independent trust paths required (default: 1)
# TRUST_POLICY_MIN_PATHS=1

# Only accept issuers with direct vouches from trusted roots (default: false)
# TRUST_POLICY_REQUIRE_DIRECT=false

# Comma-separated list of trusted root issuer IDs
# These issuers are always trusted without traversing the trust graph
# TRUST_POLICY_TRUSTED_ROOTS=issuer:mozilla:v1,issuer:eff:v1

# Comma-separated list of blocked issuer IDs
# These issuers are never trusted, even with valid vouches
# TRUST_POLICY_BLOCKED_ISSUERS=issuer:compromised:v1

# How often to refresh federation metadata (supports: 30m, 1h, 1d)
# TRUST_POLICY_REFRESH_INTERVAL=1h

# Minimum trust level for vouches (0-100, default: 50)
# TRUST_POLICY_MIN_TRUST_LEVEL=50

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# Log level (options: trace, debug, info, warn, error)
# Format: "level" or "level,module=level" for granular control
# Examples:
#   RUST_LOG=info                          # All modules at info level
#   RUST_LOG=debug                         # All modules at debug level
#   RUST_LOG=info,freebird=debug           # Freebird at debug, others at info
#   RUST_LOG=info,axum=warn,tower_http=off # Fine-grained control
RUST_LOG=info,freebird=debug

# Log format (options: plain, json)
LOG_FORMAT=plain

# =============================================================================
# DEPLOYMENT NOTES
# =============================================================================
#
# VALIDATE CONFIGURATION:
#   Before starting the issuer, validate your configuration:
#     source .env && freebird-validate-config
#
#   This will check for common configuration errors and missing files.
#
# DURATION FORMAT:
#   Most duration fields support human-readable formats:
#     - 30d  = 30 days
#     - 24h  = 24 hours
#     - 30m  = 30 minutes
#     - 45s  = 45 seconds
#     - 1d12h = 1 day and 12 hours (combined)
#     - 3600  = raw seconds (backward compatible)
#
# DEVELOPMENT:
#   - Use the defaults provided above
#   - SYBIL_RESISTANCE=invitation with bootstrap users works well
#   - REDIS_URL can be omitted for testing (uses in-memory storage)
#
# PRODUCTION:
#   - CHANGE ADMIN_API_KEY to a secure random value (use secrets manager)
#   - CHANGE all default salts (SYBIL_*_SALT variables)
#   - Set REQUIRE_TLS=true
#   - Set BEHIND_PROXY=true if using a reverse proxy
#   - Use REDIS_URL for persistent nullifier storage
#   - Deploy issuer and verifier on separate infrastructure
#   - Use proper TLS certificates (not self-signed)
#   - Consider HSM for key storage (see .env.hsm.example)
#
# DEBUGGING:
#   - Set RUST_LOG=debug or RUST_LOG=trace for verbose logging
#   - Check Docker logs: docker-compose logs -f issuer
#   - Verify connectivity: curl http://localhost:8081/.well-known/issuer
#
# =============================================================================
